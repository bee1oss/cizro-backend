generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  SELLER
  CLIENT
}

enum StoreStatus {
  PENDING
  APPROVED
  REJECTED
}

enum EnumOrderStatus {
  PENDING
  PAID
}

model User {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  email    String  @unique
  password String
  fullName String?
  phone    String?

  roles Role[] // çok rollü: ADMIN, SELLER, CLIENT

  // relations
  stores         Store[]        @relation("StoreOwner") // sahip olduğu mağazalar
  orders         Order[]        @relation("OrderBuyer") // verdiği siparişler
  reviews        Review[] // yazdığı yorumlar
  favorites      Product[]
  refreshTokens  RefreshToken[] // RT kayıtları
  approvedStores Store[]        @relation("StoreApprovedBy") // admin olarak onayladıkları

  @@map("user")
}

model Store {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  title       String
  description String?

  owner   User   @relation("StoreOwner", fields: [ownerId], references: [id])
  ownerId String

  status       StoreStatus @default(PENDING)
  approvedAt   DateTime?
  approvedBy   User?       @relation("StoreApprovedBy", fields: [approvedById], references: [id])
  approvedById String?
  rejectReason String?

  products   Product[]
  colors     Color[]
  reviews    Review[]
  orderItems OrderItem[] // satış raporları için denormalize

  @@index([ownerId])
  @@index([status])
  @@map("store")
}

model Category {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  title    String
  slug     String  @unique
  isActive Boolean @default(true)

  products Product[]

  @@unique([title])
  @@map("category")
}

model Product {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  title       String
  description String
  price       Decimal  @db.Decimal(10, 2)
  images      String[]

  store   Store  @relation(fields: [storeId], references: [id])
  storeId String

  category   Category? @relation(fields: [categoryId], references: [id], onDelete: Restrict)
  categoryId String?

  color   Color?  @relation(fields: [colorId], references: [id])
  colorId String?

  orderItems OrderItem[]
  reviews    Review[]
  User       User?       @relation(fields: [userId], references: [id])
  userId     String?

  @@index([storeId])
  @@index([categoryId])
  @@index([colorId])
  @@map("product")
}

model Color {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  name  String
  value String // örn: #RRGGBB (uygulama tarafında doğrula)

  products Product[] // renk birden çok üründe kullanılabilir

  store   Store  @relation(fields: [storeId], references: [id])
  storeId String

  @@unique([storeId, name]) // aynı mağazada aynı isimli renk olmasın
  @@index([storeId])
  @@map("color")
}

model Order {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  status EnumOrderStatus @default(PENDING)
  total  Decimal         @db.Decimal(10, 2)

  buyer   User   @relation("OrderBuyer", fields: [buyerId], references: [id])
  buyerId String

  items OrderItem[]

  @@index([buyerId])
  @@map("order")
}

model OrderItem {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  quantity Int
  price    Decimal @db.Decimal(10, 2)

  order   Order  @relation(fields: [orderId], references: [id])
  orderId String

  store   Store  @relation(fields: [storeId], references: [id])
  storeId String

  product   Product @relation(fields: [productId], references: [id])
  productId String

  @@index([storeId, createdAt])
  @@index([orderId])
  @@index([productId])
  @@map("order_item")
}

model Review {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  text   String
  rating Int // 1..5 (DTO ile doğrula)

  author   User   @relation(fields: [authorId], references: [id])
  authorId String

  store     Store?   @relation(fields: [storeId], references: [id])
  storeId   String?
  product   Product? @relation(fields: [productId], references: [id])
  productId String?

  @@index([authorId])
  @@index([storeId])
  @@index([productId])
  @@map("review")
}

model RefreshToken {
  id        String    @id @default(cuid())
  tokenHash String    @unique // raw yerine hash saklanır
  userId    String
  user      User      @relation(fields: [userId], references: [id])
  createdAt DateTime  @default(now())
  expiresAt DateTime
  revokedAt DateTime?
  userAgent String?
  ip        String?

  // Rotation zinciri (self relation)
  replacedById String?
  replacedBy   RefreshToken?  @relation("RTReplace", fields: [replacedById], references: [id])
  replaced     RefreshToken[] @relation("RTReplace")

  @@index([userId])
  @@index([expiresAt])
  @@map("refresh_token")
}
